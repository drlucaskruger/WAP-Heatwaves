---
title: Detection of extreme heatwaves and low sea ice cover in the Antarctic Peninsula  for
  evaluation of effects over Krill
author: "Lucas Krüger, Maurício Mardones, Lorena Rebolledo"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#---------- Download NOAA erddap optimum interpolation SST----

#this part of the script is a modification of the scripts in the heatwaveR vignette
#available at https://robwschlegel.github.io/heatwaveR/articles/OISST_preparation.html


```{r, echo =FALSE}
#---------- Download NOAA erdap optimum interpolation SST----

# The packages we will use
library(dplyr) # A staple for modern data management in R
library(lubridate) # Useful functions for dealing with dates
library(ggplot2) # The preferred library for data visualisation
library(tidync) # For easily dealing with NetCDF data
library(rerddap) # For easily downloading subsets of data
library(doParallel) # For parallel processing
library(raster)
library(terra)
library(sf)

```

# The information for the NOAA OISST data

```{r, echo=FALSE}


rerddap::info(datasetid = "ncdcOisst21Agg_LonPM180", url = "https://coastwatch.pfeg.noaa.gov/erddap/")

```

# This function downloads and prepares data based on user provided start and end dates using three different requests, as my PC did not have memory enough to run on a single request.

```{r}


# spatial units to use



shp<-shapefile("D:/HeatWaves/Krill/Data/Shapefiles/StrataSub.shp")
plot(shp)

crs=CRS( "+proj=longlat +datum=WGS84 +no_defs") # coordinate reference system CRS

shp2<-spTransform(shp,crs)
shp.sf<-st_as_sf(shp2)
unique(shp.sf$ID)

#Extract coordinates
bbox_list <- lapply(st_geometry(shp.sf), st_bbox)

#To df
maxmin <- as.data.frame(matrix(unlist(bbox_list),nrow=nrow(shp.sf)))

#get names
names(maxmin) <- names(bbox_list[[1]])

sf2=bind_cols(shp.sf,maxmin)


OISST_sub_dl <- function(time_df){
  OISST_DATA <- rerddap::griddap(datasetx = "ncdcOisst21Agg_LonPM180",
                                url = "https://coastwatch.pfeg.noaa.gov/erddap/", 
                                time = c(time_df$start, time_df$end), 
                                zlev = c(0, 0),
                                latitude = c(min(sf2$ymin),max(sf2$ymax)),
                                longitude = c(min(sf2$xmin),max(sf2$xmax)),
                                fields = c("sst","ice"))$data %>% 
    dplyr::mutate(time = base::as.Date(stringr::str_remove(time, "T12:00:00Z"))) %>% 
    dplyr::rename(t = time, temp = sst, sic=ice,lon = longitude, lat = latitude) %>% 
    dplyr::select(lon, lat, t, temp,sic) %>% 
    stats::na.omit()
}




dl_years1 <- data.frame(date_index = 1:3,
                        start = as.Date(c("1985-01-01","1990-01-01","1995-01-01")),
                        
                        end = as.Date(c("1989-12-31","1994-12-31","1999-12-31")))


dl_years2 <- data.frame(date_index = 1:3,
                        start = as.Date(c("2000-01-01", "2005-01-01", "2010-01-01")),
                        
                        end = as.Date(c("2004-12-31", "2009-12-31","2014-12-31")))


dl_years3 <- data.frame(date_index = 1:3,
                        start = as.Date(c("2015-01-01","2020-01-01","2021-01-01")),
                        
                        end = as.Date(c("2019-12-31","2020-12-31","2022-12-31")))

```

###download and save data

```{r}

base::system.time(
  OISST_data1 <- dl_years1 %>% 
    dplyr::group_by(date_index) %>% 
    dplyr::group_modify(~OISST_sub_dl(.x)) %>% 
    dplyr::ungroup() %>% 
    dplyr::select(lon, lat, t, temp,sic)
) # 518 seconds, ~100 seconds per batch


base::system.time(
  OISST_data2 <- dl_years2 %>% 
    dplyr::group_by(date_index) %>% 
    dplyr::group_modify(~OISST_sub_dl(.x)) %>% 
    dplyr::ungroup() %>% 
    dplyr::select(lon, lat, t, temp,sic)
)


base::system.time(
  OISST_data3 <- dl_years3 %>% 
    dplyr::group_by(date_index) %>% 
    dplyr::group_modify(~OISST_sub_dl(.x)) %>% 
    dplyr::ungroup() %>% 
    dplyr::select(lon, lat, t, temp,sic)
)

base::saveRDS(OISST_data1, file = "D:/HeatWaves/Krill/Data/OISST_data1.Rds")
base::saveRDS(OISST_data2, file = "D:/HeatWaves/Krill/Data/OISST_data2.Rds")
base::saveRDS(OISST_data3, file = "D:/HeatWaves/Krill/Data/OISST_data3.Rds")


rm(list=c("OISST_data1","OISST_data2","OISST_data3"))

gc()

```
###----------- calculating marine heatwaves-------------


### first load management units and extract climate data
```{r}

library(heatwaveR)
library(udunits2)
library(patchwork)
library(raster)
library(ncdf4)
library(terra)
library(sf)
library(spatialEco)
library(doParallel) # For parallel processing

### subset data based on the krill fishery management strata


shp<-shapefile("D:/HeatWaves/Krill/Data/Shapefiles/StrataSub.shp")
plot(shp)

crs=CRS( "+proj=longlat +datum=WGS84 +no_defs") # coordinate reference system CRS

shp2<-spTransform(shp,crs)
shp.sf<-st_as_sf(shp2)



df3<-base::readRDS("D:/HeatWaves/Krill/Data/OISST_data3.Rds")

spdf3 <- st_as_sf(x = df3,                         
           coords = c("lon", "lat"),
           crs = crs)

rm(list=c("df3"))
gc()

spdf3a<-spdf3[1:10000000,1:4]
spdf3b<-spdf3[10001:20000,1:4]
spdf3c<-spdf3[20001:10000,1:4]


stdf3<-(st_intersection(shp.sf,spdf3))

rm(list=c("spdf3"))

spdf

wapM3<-ddply(stdf3, c("t","Sector"), summarise,
            tSD=sd(temp),tMax=max(temp),
            tMin=min(temp),temp=mean(temp),
            sicMean=mean(sic),sicMax=max(sic),
            sicMin=min(sic),sicSD=sd(sic))



gc()



df1<-base::readRDS("D:/HeatWaves/Krill/Data/OISST_data1.Rds")


spdf1 <- st_as_sf(x = df1,                         
           coords = c("lon", "lat"),
           crs = crs)




df2<-base::readRDS("D:/HeatWaves/Krill/Data/OISST_data2.Rds")


spdf2 <- st_as_sf(x = df2,                         
           coords = c("lon", "lat"),
           crs = crs)



stdf1<-(st_intersection(shp.sf,spdf1))


stdf1<-na.omit(cbind(stdf1,df1))   # join the data and omit missing values
stdf2<-na.omit(cbind(strata1,df2)) 
stdf3<-na.omit(cbind(strata1,df3)) 


wapM1<-ddply(stdf1, c("t","Sector"), summarise,
            tSD=sd(temp),tMax=max(temp),
            tMin=min(temp),temp=mean(temp),
            sicMean=mean(sic),sicMax=max(sic),
            sicMin=min(sic),sicSD=sd(sic)) ### summarize data per day

wapM2<-ddply(stdf1, c("t","Sector"), summarise,
            tSD=sd(temp),tMax=max(temp),
            tMin=min(temp),temp=mean(temp),
            sicMean=mean(sic),sicMax=max(sic),
            sicMin=min(sic),sicSD=sd(sic))

wapM3<-ddply(stdf1, c("t","Sector"), summarise,
            tSD=sd(temp),tMax=max(temp),
            tMin=min(temp),temp=mean(temp),
            sicMean=mean(sic),sicMax=max(sic),
            sicMin=min(sic),sicSD=sd(sic))



```